{% extends 'base.html' %}
{% block title %}Nueva orden | Malargüe Tech{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-xl-10">
    <div class="card app-card">
      <div class="card-body p-4 p-md-5">
        <p class="eyebrow mb-2">Paso 2 de 2</p>
        <h1 class="h4 mb-2">Completar orden de reparación</h1>
        <p class="text-muted mb-4">Cargá los datos de la orden y, si corresponde, los repuestos a utilizar.</p>

        <form method="post" class="row g-4">
          {% csrf_token %}

          <div class="col-lg-7">
            <h2 class="h6 mb-3">Datos de orden</h2>
            <div class="row g-3">
              {% for field in form %}
                <div class="col-12">
                  <label class="form-label fw-semibold" for="{{ field.id_for_label }}">{{ field.label }}</label>
                  {{ field }}
                  {% if field.errors %}
                    <div class="text-danger small mt-1">{{ field.errors|striptags }}</div>
                  {% else %}
                    {% if field.name == 'problema_reportado' %}
                      <div class="helper-text mt-1">Describí de forma concreta lo que reporta el cliente.</div>
                    {% endif %}
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>

          <div class="col-lg-5">
            <h2 class="h6 mb-3">Repuestos (opcionales)</h2>
            <p class="helper-text mb-3">Al guardar se valida stock disponible para cada repuesto cargado.</p>
            {{ formset.management_form }}
            <div class="repuestos-scroll">
              <div id="repuestos-formset" class="vstack gap-3">
                {% for repuesto_form in formset %}
                  <div class="border rounded-3 p-3 bg-light-subtle repuesto-form-item">
                    <p class="helper-text mb-2">Línea {{ forloop.counter }}</p>
                    {% for hidden in repuesto_form.hidden_fields %}{{ hidden }}{% endfor %}
                    <div class="mb-2">
                      <label class="form-label mb-1">Repuesto</label>
                      {{ repuesto_form.repuesto }}
                    </div>
                    <div class="row g-2">
                      <div class="col-6">
                        <label class="form-label mb-1">Cantidad</label>
                        {{ repuesto_form.cantidad }}
                      </div>
                      <div class="col-6">
                        <label class="form-label mb-1">Precio unitario</label>
                        {{ repuesto_form.precio_unitario }}
                      </div>
                    </div>
                    {% if repuesto_form.errors %}
                      <div class="text-danger small mt-2">{{ repuesto_form.errors|striptags }}</div>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
            <div class="mt-3">
              <button type="button" id="add-repuesto" class="btn btn-sm btn-outline-secondary">+ Añadir repuesto</button>
            </div>

            <template id="empty-repuesto-form-template">
              <div class="border rounded-3 p-3 bg-light-subtle repuesto-form-item">
                <p class="helper-text mb-2">Línea __line__</p>
                {% for hidden in formset.empty_form.hidden_fields %}{{ hidden }}{% endfor %}
                <div class="mb-2">
                  <label class="form-label mb-1">Repuesto</label>
                  {{ formset.empty_form.repuesto }}
                </div>
                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label mb-1">Cantidad</label>
                    {{ formset.empty_form.cantidad }}
                  </div>
                  <div class="col-6">
                    <label class="form-label mb-1">Precio unitario</label>
                    {{ formset.empty_form.precio_unitario }}
                  </div>
                </div>
              </div>
            </template>
          </div>

          <div class="col-12 d-flex justify-content-end gap-2">
            <a href="{% url 'ordenes_list' %}" class="btn btn-outline-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary">Guardar orden</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const addButton = document.getElementById('add-repuesto');
    const container = document.getElementById('repuestos-formset');
    const template = document.getElementById('empty-repuesto-form-template');
    const totalFormsInput = document.getElementById('id_repuestos-TOTAL_FORMS');

    if (!addButton || !container || !template || !totalFormsInput) {
      return;
    }

    addButton.addEventListener('click', function () {
      const formIndex = parseInt(totalFormsInput.value, 10);
      const lineNumber = formIndex + 1;
      const html = template.innerHTML
        .replaceAll('__prefix__', formIndex)
        .replace('__line__', lineNumber);

      container.insertAdjacentHTML('beforeend', html);
      totalFormsInput.value = formIndex + 1;
    });
  })();
</script>
{% endblock %}
